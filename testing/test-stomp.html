<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Test WebSocket 2 User (Chat Realtime)</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      .user-container {
        border: 1px solid #ccc;
        padding: 20px;
        margin: 20px;
        width: 45%;
        display: inline-block;
        vertical-align: top;
      }
      .messages {
        border: 1px solid #aaa;
        height: 200px;
        overflow-y: scroll;
        margin-top: 10px;
        padding: 10px;
        background: #f9f9f9;
      }
      .status {
        color: green;
        font-weight: bold;
        margin-top: 10px;
      }
      .error {
        color: red;
        font-weight: bold;
        margin-top: 10px;
      }
      .debug-panel {
        margin-top: 20px;
        padding: 10px;
        background: #f0f0f0;
        border: 1px solid #ddd;
      }
      .id-info {
        font-size: 12px;
        color: #666;
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <h1>Giả lập User và Company chat với nhau qua WebSocket</h1>

    <div class="user-container">
      <h2>User</h2>
      <div class="id-info">
        <p><b>User ID (để kết nối):</b> 345eb03c-d19b-4c3e-88b9-251f66cc6ac8</p>
      </div>
      <input
        type="text"
        id="userContent"
        placeholder="Nội dung tin nhắn"
      /><br /><br />
      <input
        type="text"
        id="userConversationId"
        placeholder="Conversation ID"
        value="conv-001"
      /><br /><br />
      <input
        type="text"
        id="userRescueCompanyId"
        placeholder="Rescue Company ID"
        value="d1e9b874-169d-4424-9ff6-d9997a6b60de"
      /><br /><br />
      <button onclick="connect('user')">Connect User</button>
      <button onclick="sendMessage('user')">Gửi tin nhắn User</button>
      <button onclick="disconnect('user')">Disconnect</button>
      <div class="status" id="userStatus"></div>
      <div class="messages" id="userMessages"></div>
    </div>

    <div class="user-container">
      <h2>Company</h2>
      <div class="id-info">
        <p><b>User ID (để kết nối):</b> 066e5c34-0101-4d69-a32f-44cb0616368c</p>
        <p><b>Company ID:</b> d1e9b874-169d-4424-9ff6-d9997a6b60de</p>
      </div>
      <input
        type="text"
        id="companyContent"
        placeholder="Nội dung tin nhắn"
      /><br /><br />
      <input
        type="text"
        id="companyConversationId"
        placeholder="Conversation ID"
        value="conv-001"
      /><br /><br />
      <input
        type="text"
        id="companyUserId"
        placeholder="User ID"
        value="345eb03c-d19b-4c3e-88b9-251f66cc6ac8"
      /><br /><br />
      <button onclick="connect('company')">Connect Company</button>
      <button onclick="sendMessage('company')">Gửi tin nhắn Company</button>
      <button onclick="disconnect('company')">Disconnect</button>
      <div class="status" id="companyStatus"></div>
      <div class="messages" id="companyMessages"></div>
    </div>

    <div class="debug-panel">
      <h3>Debug Information</h3>
      <div id="debugLog"></div>
    </div>

    <script>
      const users = {
        user: {
          id: "345eb03c-d19b-4c3e-88b9-251f66cc6ac8", // ID của user để kết nối
          token:
            "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ1c2VyIiwidXNlcklkIjoiMzQ1ZWIwM2MtZDE5Yi00YzNlLTg4YjktMjUxZjY2Y2M2YWM4Iiwicm9sZXMiOlsiVVNFUiJdLCJpYXQiOjE3NDU2OTU5MTAsImV4cCI6MTc0NTc2NTYwN30.UySR8rjI-MG1YOkMflUukBnFmJtA-tLv-bLe1NZqSoJRd952_NncNuTiwl-3kys3hfG8NE9mDHCuyZjDtTTS3A",
          senderType: "USER",
        },
        company: {
          id: "066e5c34-0101-4d69-a32f-44cb0616368c", // ID của user có role COMPANY để kết nối
          companyId: "d1e9b874-169d-4424-9ff6-d9997a6b60de", // ID của company để gửi tin nhắn
          token:
            "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJjb21wYW55IiwidXNlcklkIjoiMDY2ZTVjMzQtMDEwMS00ZDY5LWEzMmYtNDRjYjA2MTYzNjhjIiwicm9sZXMiOlsiVVNFUiIsIkNPTVBBTlkiXSwiaWF0IjoxNzQ1Njk1ODU1LCJleHAiOjE3NDU3NjU1NTJ9.yzrvpVT6tpovaf5gzXsrEW4dzcgdtwyRsouKawhbzWiWW6j_jB83fRZzE_rtU8JfEFJbBAgUS8rnq0U_MyTibw",
          senderType: "RESCUE_COMPANY",
        },
      };

      let stompClients = {};

      function log(message) {
        console.log(message);
        const debugLog = document.getElementById("debugLog");
        const logEntry = document.createElement("div");
        logEntry.textContent = new Date().toLocaleTimeString() + ": " + message;
        debugLog.appendChild(logEntry);
        debugLog.scrollTop = debugLog.scrollHeight;
      }

      function setStatus(type, message, isError = false) {
        const statusElement = document.getElementById(`${type}Status`);
        statusElement.textContent = message;
        statusElement.className = isError ? "error" : "status";
      }

      function connect(type) {
        setStatus(type, "Đang kết nối...");

        const user = users[type];
        const token = user.token;

        // Tạo URL với token trong tham số query (lưu ý: đây là cách không khuyến nghị cho môi trường production)
        const wsUrl = `ws://localhost:9006/ws?token=${encodeURIComponent(
          token
        )}`;

        try {
          // Sử dụng WebSocket trực tiếp, vì chúng ta đã chỉ định URL với token
          const socket = new WebSocket(wsUrl);
          const stompClient = Stomp.over(socket);

          // Tắt log debug mặc định của STOMP
          stompClient.debug = function (str) {
            // log(str); // Bỏ comment nếu muốn xem log STOMP chi tiết
          };

          stompClient.connect(
            {}, // Headers trống vì token đã trong URL
            function (frame) {
              log(`${type} connected: ` + frame);
              stompClients[type] = stompClient;
              setStatus(type, "Đã kết nối thành công");

              // Đăng ký nhận thông báo cá nhân
              stompClient.subscribe(
                "/user/queue/notifications",
                function (messageOutput) {
                  try {
                    const message = JSON.parse(messageOutput.body);
                    log(
                      `${type} nhận được thông báo: ${JSON.stringify(message)}`
                    );
                    displayMessage(type, message);
                  } catch (e) {
                    log(`Error parsing message: ${e}`);
                    displayMessage(type, {
                      content: messageOutput.body,
                      senderType: "SYSTEM",
                    });
                  }
                }
              );

              // Đăng ký nhận thông báo public (nếu cần)
              stompClient.subscribe("/topic/public", function (messageOutput) {
                try {
                  const message = JSON.parse(messageOutput.body);
                  log(
                    `${type} nhận được thông báo public: ${JSON.stringify(
                      message
                    )}`
                  );
                  displayMessage(type, message);
                } catch (e) {
                  log(`Error parsing public message: ${e}`);
                  displayMessage(type, {
                    content: messageOutput.body,
                    senderType: "PUBLIC",
                  });
                }
              });
            },
            function (error) {
              log(`Connection error ${type}: ${error}`);
              setStatus(type, `Lỗi kết nối: ${error}`, true);
            }
          );
        } catch (error) {
          log(`Error creating connection for ${type}: ${error}`);
          setStatus(type, `Lỗi tạo kết nối: ${error}`, true);
        }
      }

      function disconnect(type) {
        const stompClient = stompClients[type];
        if (stompClient) {
          stompClient.disconnect(function () {
            log(`${type} disconnected`);
            setStatus(type, "Đã ngắt kết nối");
            stompClients[type] = null;
          });
        }
      }

      function sendMessage(type) {
        const stompClient = stompClients[type];
        if (!stompClient || !stompClient.connected) {
          alert(`${type} chưa connect!`);
          return;
        }

        const content =
          document.getElementById(`${type}Content`).value ||
          "Nội dung mặc định";
        const conversationId =
          document.getElementById(`${type}ConversationId`).value || "conv-001";

        let message;

        if (type === "user") {
          // User gửi tin nhắn cho Company
          const rescueCompanyId =
            document.getElementById(`userRescueCompanyId`).value ||
            "d1e9b874-169d-4424-9ff6-d9997a6b60de";

          message = {
            content: content,
            conversationId: conversationId,
            rescueCompanyId: rescueCompanyId,
            userId: users.user.id,
            senderType: users.user.senderType,
            isRead: false,
            sentAt: new Date().toISOString(),
          };
        } else {
          // Company gửi tin nhắn cho User
          const userId =
            document.getElementById(`companyUserId`).value ||
            "345eb03c-d19b-4c3e-88b9-251f66cc6ac8";

          message = {
            content: content,
            conversationId: conversationId,
            rescueCompanyId: users.company.companyId, // Sử dụng companyId, không phải userId
            userId: userId,
            senderType: users.company.senderType,
            isRead: false,
            sentAt: new Date().toISOString(),
          };
        }

        stompClient.send("/app/message", {}, JSON.stringify(message));
        log(`${type} gửi tin nhắn: ${JSON.stringify(message)}`);

        // Thêm tin nhắn đã gửi vào giao diện
        displayMessage(type, {
          ...message,
          senderType: message.senderType + " (You)",
        });
      }

      function displayMessage(type, message) {
        const containerId = type + "Messages";
        const container = document.getElementById(containerId);

        const div = document.createElement("div");

        let timeStr = "";
        if (message.sentAt) {
          const time = new Date(message.sentAt).toLocaleTimeString();
          timeStr = `<span style="color: #888">[${time}]</span> `;
        }

        let fromStr = "";
        if (message.userId && message.rescueCompanyId) {
          if (
            message.senderType === "USER" ||
            message.senderType === "USER (You)"
          ) {
            fromStr = `<span style="color: blue">${message.senderType}</span>`;
          } else {
            fromStr = `<span style="color: green">${message.senderType}</span>`;
          }
        } else {
          fromStr = `<span style="color: purple">${message.senderType}</span>`;
        }

        div.innerHTML = `${timeStr}${fromStr}: ${message.content}`;
        container.appendChild(div);

        // Tự động scroll xuống dưới
        container.scrollTop = container.scrollHeight;
      }

      // Xử lý khi trang đóng để ngắt kết nối
      window.onbeforeunload = function () {
        Object.keys(stompClients).forEach((type) => {
          if (stompClients[type]) {
            stompClients[type].disconnect();
          }
        });
      };
    </script>
  </body>
</html>
